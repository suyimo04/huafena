import{d as C,r as p,o as u,c as v,a as b,f as V,t as E,n as S,v as x,w as i,F as N,x as I,_ as H,s as O,b as n,j as A,m as te,y as ne,h as oe,p as L,z as X,A as re,B as se,k as ue,g as ie}from"./index-Dmpy0hQc.js";import{g as de,s as me}from"./questionnaire-6W5Ac3R0.js";import{c as ce}from"./formHelpers-BLIiThDM.js";import"./axios-DYop8cuN.js";function pe(a,r){const l=r[a.fieldKey],o=a.value;switch(a.operator){case"EQUALS":return String(l??"")===String(o);case"NOT_EQUALS":return String(l??"")!==String(o);case"CONTAINS":return Array.isArray(l)?l.some(y=>String(y)===String(o)):String(l??"").includes(String(o));case"GREATER_THAN":return Number(l)>Number(o);case"LESS_THAN":return Number(l)<Number(o);case"IN":return Array.isArray(o)?o.includes(String(l??"")):!1;case"NOT_IN":return Array.isArray(o)?!o.includes(String(l??"")):!0;default:return!1}}function K(a,r){if(!a||!a.conditions||a.conditions.length===0)return!0;const l=a.conditions.map(y=>pe(y,r)),o=a.logicOperator==="AND"?l.every(Boolean):l.some(Boolean);return a.action==="SHOW"?o:!o}function ve(a,r){var y,m;if(a.required){if(r==null||r==="")return((y=a.validationRules)==null?void 0:y.customMessage)??`${a.label}为必填项`;if(Array.isArray(r)&&r.length===0)return((m=a.validationRules)==null?void 0:m.customMessage)??`${a.label}为必填项`}if(r==null||r===""||Array.isArray(r)&&r.length===0)return null;const l=a.validationRules;if(!l)return null;const o=l.customMessage;if(a.type==="TEXT"){const s=String(r);if(l.minLength!==void 0&&s.length<l.minLength)return o??`${a.label}长度不能少于${l.minLength}个字符`;if(l.maxLength!==void 0&&s.length>l.maxLength)return o??`${a.label}长度不能超过${l.maxLength}个字符`;if(l.pattern&&!new RegExp(l.pattern).test(s))return o??`${a.label}格式不正确`}if(a.type==="NUMBER"){const s=Number(r);if(l.min!==void 0&&s<l.min)return o??`${a.label}不能小于${l.min}`;if(l.max!==void 0&&s>l.max)return o??`${a.label}不能大于${l.max}`}if(a.type==="DATE"){const s=String(r);if(l.minDate&&s<l.minDate)return o??`${a.label}不能早于${l.minDate}`;if(l.maxDate&&s>l.maxDate)return o??`${a.label}不能晚于${l.maxDate}`}if(a.type==="MULTI_CHOICE"&&Array.isArray(r)){if(l.minSelect!==void 0&&r.length<l.minSelect)return o??`${a.label}至少选择${l.minSelect}项`;if(l.maxSelect!==void 0&&r.length>l.maxSelect)return o??`${a.label}最多选择${l.maxSelect}项`}return null}const fe={class:"field-renderer"},be={class:"field-label"},ye={key:0,class:"field-required-star"},ge={key:6,class:"field-error"},_e=C({__name:"FieldRenderer",props:{field:{},modelValue:{},error:{}},emits:["update:modelValue"],setup(a){return(r,l)=>{const o=p("el-input"),y=p("el-input-number"),m=p("el-radio"),s=p("el-radio-group"),U=p("el-checkbox"),$=p("el-checkbox-group"),M=p("el-option"),h=p("el-select"),R=p("el-date-picker");return u(),v("div",fe,[b("label",be,[V(E(a.field.label)+" ",1),a.field.required?(u(),v("span",ye,"*")):S("",!0)]),a.field.type==="TEXT"?(u(),x(o,{key:0,"model-value":a.modelValue,placeholder:"请输入","onUpdate:modelValue":l[0]||(l[0]=e=>r.$emit("update:modelValue",e))},null,8,["model-value"])):a.field.type==="NUMBER"?(u(),x(y,{key:1,"model-value":a.modelValue,controls:!0,placeholder:"请输入数字","onUpdate:modelValue":l[1]||(l[1]=e=>r.$emit("update:modelValue",e))},null,8,["model-value"])):a.field.type==="SINGLE_CHOICE"?(u(),x(s,{key:2,"model-value":a.modelValue,"onUpdate:modelValue":l[2]||(l[2]=e=>r.$emit("update:modelValue",e))},{default:i(()=>[(u(!0),v(N,null,I(a.field.options??[],e=>(u(),x(m,{key:e.value,value:e.value},{default:i(()=>[V(E(e.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["model-value"])):a.field.type==="MULTI_CHOICE"?(u(),x($,{key:3,"model-value":a.modelValue??[],"onUpdate:modelValue":l[3]||(l[3]=e=>r.$emit("update:modelValue",e))},{default:i(()=>[(u(!0),v(N,null,I(a.field.options??[],e=>(u(),x(U,{key:e.value,label:e.value,value:e.value},{default:i(()=>[V(E(e.label),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["model-value"])):a.field.type==="DROPDOWN"?(u(),x(h,{key:4,"model-value":a.modelValue,placeholder:"请选择","onUpdate:modelValue":l[4]||(l[4]=e=>r.$emit("update:modelValue",e))},{default:i(()=>[(u(!0),v(N,null,I(a.field.options??[],e=>(u(),x(M,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:1},8,["model-value"])):a.field.type==="DATE"?(u(),x(R,{key:5,"model-value":a.modelValue,type:"date",placeholder:"请选择日期","value-format":"YYYY-MM-DD","onUpdate:modelValue":l[5]||(l[5]=e=>r.$emit("update:modelValue",e))},null,8,["model-value"])):S("",!0),a.error?(u(),v("div",ge,E(a.error),1)):S("",!0)])}}}),Z=H(_e,[["__scopeId","data-v-3422d328"]]),ke={class:"group-renderer"},xe={class:"group-title"},De=C({__name:"GroupRenderer",props:{group:{},fields:{},answers:{},errors:{}},emits:["update:answer"],setup(a){const r=a,l=O(()=>r.fields.filter(o=>K(o.conditionalLogic,r.answers)));return(o,y)=>(u(),v("div",ke,[b("h3",xe,E(a.group.name),1),(u(!0),v(N,null,I(l.value,m=>(u(),x(Z,{key:m.key,field:m,"model-value":a.answers[m.key],error:a.errors[m.key]??null,"onUpdate:modelValue":s=>o.$emit("update:answer",m.key,s)},null,8,["field","model-value","error","onUpdate:modelValue"]))),128))]))}}),Ve=H(De,[["__scopeId","data-v-7c6ac147"]]),Ae={class:"questionnaire-renderer"},we={key:0,class:"ungrouped-section"},Ee={class:"renderer-actions"},he=C({__name:"QuestionnaireRenderer",props:{schema:{}},emits:["submit"],setup(a,{expose:r,emit:l}){const o=a,y=l,m=A({}),s=A({}),U=O(()=>{const d=new Map;for(const c of o.schema.fields)d.set(c.key,c);return d}),$=O(()=>[...o.schema.groups].sort((d,c)=>d.sortOrder-c.sortOrder)),M=O(()=>{const d=new Set;for(const c of o.schema.groups)for(const T of c.fields)d.add(T);return d}),h=O(()=>o.schema.fields.filter(d=>!M.value.has(d.key))),R=O(()=>h.value.filter(d=>K(d.conditionalLogic,m.value)));function e(d){return d.fields.map(c=>U.value.get(c)).filter(c=>!!c)}function F(d,c){m.value[d]=c,s.value[d]&&delete s.value[d]}function Y(){const d={};for(const c of o.schema.fields){if(!K(c.conditionalLogic,m.value))continue;const g=ve(c,m.value[c.key]);g&&(d[c.key]=g)}return s.value=d,d}function Q(){return{...m.value}}function B(){const d=Y();Object.keys(d).length===0&&y("submit",Q())}return r({validate:Y,getAnswers:Q}),(d,c)=>{const T=p("el-button");return u(),v("div",Ae,[(u(!0),v(N,null,I($.value,g=>(u(),x(Ve,{key:g.name,group:g,fields:e(g),answers:m.value,errors:s.value,"onUpdate:answer":F},null,8,["group","fields","answers","errors"]))),128)),h.value.length>0?(u(),v("div",we,[(u(!0),v(N,null,I(R.value,g=>(u(),x(Z,{key:g.key,field:g,"model-value":m.value[g.key],error:s.value[g.key]??null,"onUpdate:modelValue":z=>F(g.key,z)},null,8,["field","model-value","error","onUpdate:modelValue"]))),128))])):S("",!0),b("div",Ee,[n(T,{type:"primary",onClick:B},{default:i(()=>[...c[0]||(c[0]=[V("提交",-1)])]),_:1})])])}}}),Se=H(he,[["__scopeId","data-v-085fd82c"]]),Ne={class:"public-questionnaire-page"},Ue={class:"public-card theme-card"},$e={key:0,class:"state-container"},Te={key:1,class:"state-container"},Oe={class:"state-text error-text"},Re={key:2,class:"state-container success-container"},Fe={class:"account-info"},Ie={class:"info-row"},Me={class:"info-value"},Ye={class:"info-row"},Le={class:"info-value"},Ce={key:0,class:"age-display"},He={key:0,class:"submitting-overlay"},Qe=C({__name:"PublicQuestionnairePage",setup(a){const r=oe(),l=ie(),o=A(!0),y=A(""),m=A(null),s=A(!1),U=A(!1),$=A({username:"",password:""}),M=A(null),h=A(),R=r.params.linkToken,e=ue({pollenUid:"",birthDate:"",educationStage:"",examFlag:!1,examType:"",examDate:"",weeklyAvailableDays:3,dailyAvailableHours:2,weeklyAvailableSlots:[]}),F=O(()=>e.birthDate?ce(e.birthDate):null);function Y(D){return D.getTime()>Date.now()}te(()=>e.examFlag,D=>{D||(e.examType="",e.examDate="")});const c={pollenUid:[{required:!0,validator:(D,t,_)=>{if(!t){_(new Error("请输入花粉 UID（QQ号）"));return}if(!/^[1-9]\d{4,10}$/.test(t)){_(new Error("QQ号格式不正确，需为5-11位纯数字且首位不为0"));return}_()},trigger:"blur"}],birthDate:[{required:!0,message:"请选择出生日期",trigger:"change"}],educationStage:[{required:!0,message:"请选择教育阶段",trigger:"change"}],examType:[{validator:(D,t,_)=>{e.examFlag&&!t?_(new Error("请选择考试类型")):_()},trigger:"change"}],examDate:[{validator:(D,t,_)=>{e.examFlag&&!t?_(new Error("请选择考试日期")):_()},trigger:"change"}],weeklyAvailableDays:[{required:!0,message:"请填写每周可用天数",trigger:"change"}],dailyAvailableHours:[{required:!0,message:"请填写每日可用时长",trigger:"change"}],weeklyAvailableSlots:[{required:!0,message:"请选择至少一个可用时段",trigger:"change",type:"array",min:1}]};async function T(){o.value=!0,y.value="";try{const D=await de(R);m.value=D.data}catch{y.value="链接无效或已过期"}finally{o.value=!1}}async function g(D){if(!(h.value&&!await h.value.validate().catch(()=>!1))){s.value=!0;try{const t=await me(R,{...D,pollenUid:e.pollenUid,birthDate:e.birthDate,educationStage:e.educationStage,examFlag:e.examFlag,examType:e.examFlag?e.examType:null,examDate:e.examFlag?e.examDate:null,weeklyAvailableDays:e.weeklyAvailableDays,dailyAvailableHours:e.dailyAvailableHours,weeklyAvailableSlots:e.weeklyAvailableSlots});$.value=t.data,U.value=!0}catch{}finally{s.value=!1}}}function z(){l.push("/login")}return ne(T),(D,t)=>{const _=p("el-icon"),P=p("el-button"),G=p("el-divider"),J=p("el-input"),w=p("el-form-item"),W=p("el-date-picker"),ee=p("el-tag"),k=p("el-option"),q=p("el-select"),le=p("el-checkbox"),j=p("el-input-number"),ae=p("el-form");return u(),v("div",Ne,[b("div",Ue,[o.value?(u(),v("div",$e,[n(_,{class:"is-loading",size:32},{default:i(()=>[n(L(X))]),_:1}),t[9]||(t[9]=b("p",{class:"state-text"},"正在加载问卷…",-1))])):y.value?(u(),v("div",Te,[n(_,{size:48,color:"#f56c6c"},{default:i(()=>[n(L(re))]),_:1}),b("p",Oe,E(y.value),1),n(P,{type:"primary",onClick:T},{default:i(()=>[...t[10]||(t[10]=[V("重试",-1)])]),_:1})])):U.value?(u(),v("div",Re,[n(_,{size:48,color:"#10b981"},{default:i(()=>[n(L(se))]),_:1}),t[14]||(t[14]=b("h2",{class:"success-title"},"提交成功",-1)),t[15]||(t[15]=b("p",{class:"state-text"},"您的问卷已成功提交，以下是您的账户信息，请妥善保管：",-1)),b("div",Fe,[b("div",Ie,[t[11]||(t[11]=b("span",{class:"info-label"},"用户名：",-1)),b("span",Me,E($.value.username),1)]),b("div",Ye,[t[12]||(t[12]=b("span",{class:"info-label"},"密码：",-1)),b("span",Le,E($.value.password),1)])]),n(P,{type:"primary",onClick:z},{default:i(()=>[...t[13]||(t[13]=[V("前往登录",-1)])]),_:1})])):m.value?(u(),v(N,{key:3},[t[21]||(t[21]=b("h2",{class:"form-title"},"问卷填写",-1)),n(ae,{ref_key:"appFormRef",ref:h,model:e,rules:c,"label-position":"top"},{default:i(()=>[n(G,null,{default:i(()=>[...t[16]||(t[16]=[V("申请信息",-1)])]),_:1}),n(w,{label:"花粉 UID（QQ号）",prop:"pollenUid"},{default:i(()=>[n(J,{modelValue:e.pollenUid,"onUpdate:modelValue":t[0]||(t[0]=f=>e.pollenUid=f),placeholder:"请输入QQ号（5-11位纯数字）",size:"large",disabled:s.value},null,8,["modelValue","disabled"])]),_:1}),n(w,{label:"出生年月",prop:"birthDate"},{default:i(()=>[n(W,{modelValue:e.birthDate,"onUpdate:modelValue":t[1]||(t[1]=f=>e.birthDate=f),type:"date",placeholder:"请选择出生日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",size:"large",disabled:s.value,"disabled-date":Y,style:{width:"100%"}},null,8,["modelValue","disabled"])]),_:1}),F.value!==null?(u(),v("div",Ce,[n(ee,{type:F.value<18?"danger":"success",size:"small"},{default:i(()=>[V(" 当前年龄："+E(F.value)+" 岁 ",1)]),_:1},8,["type"])])):S("",!0),n(w,{label:"教育阶段",prop:"educationStage"},{default:i(()=>[n(q,{modelValue:e.educationStage,"onUpdate:modelValue":t[2]||(t[2]=f=>e.educationStage=f),placeholder:"请选择教育阶段",size:"large",disabled:s.value,style:{width:"100%"}},{default:i(()=>[n(k,{label:"初中",value:"MIDDLE_SCHOOL"}),n(k,{label:"高中",value:"HIGH_SCHOOL"}),n(k,{label:"大学",value:"UNIVERSITY"}),n(k,{label:"研究生",value:"GRADUATE"}),n(k,{label:"非学生",value:"NON_STUDENT"})]),_:1},8,["modelValue","disabled"])]),_:1}),n(w,null,{default:i(()=>[n(le,{modelValue:e.examFlag,"onUpdate:modelValue":t[3]||(t[3]=f=>e.examFlag=f),disabled:s.value},{default:i(()=>[...t[17]||(t[17]=[V(" 即将参加中考或高考 ",-1)])]),_:1},8,["modelValue","disabled"])]),_:1}),e.examFlag?(u(),v(N,{key:1},[n(w,{label:"考试类型",prop:"examType"},{default:i(()=>[n(q,{modelValue:e.examType,"onUpdate:modelValue":t[4]||(t[4]=f=>e.examType=f),placeholder:"请选择考试类型",size:"large",disabled:s.value,style:{width:"100%"}},{default:i(()=>[n(k,{label:"中考",value:"ZHONGKAO"}),n(k,{label:"高考",value:"GAOKAO"})]),_:1},8,["modelValue","disabled"])]),_:1}),n(w,{label:"考试日期",prop:"examDate"},{default:i(()=>[n(W,{modelValue:e.examDate,"onUpdate:modelValue":t[5]||(t[5]=f=>e.examDate=f),type:"date",placeholder:"请选择考试日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",size:"large",disabled:s.value,style:{width:"100%"}},null,8,["modelValue","disabled"])]),_:1})],64)):S("",!0),n(G,null,{default:i(()=>[...t[18]||(t[18]=[V("可用性承诺",-1)])]),_:1}),n(w,{label:"每周可用天数",prop:"weeklyAvailableDays"},{default:i(()=>[n(j,{modelValue:e.weeklyAvailableDays,"onUpdate:modelValue":t[6]||(t[6]=f=>e.weeklyAvailableDays=f),min:1,max:7,size:"large",disabled:s.value,style:{width:"100%"}},null,8,["modelValue","disabled"])]),_:1}),n(w,{label:"每日可用时长（小时）",prop:"dailyAvailableHours"},{default:i(()=>[n(j,{modelValue:e.dailyAvailableHours,"onUpdate:modelValue":t[7]||(t[7]=f=>e.dailyAvailableHours=f),min:.5,max:24,step:.5,precision:1,size:"large",disabled:s.value,style:{width:"100%"}},null,8,["modelValue","disabled"])]),_:1}),n(w,{label:"每周可用时段",prop:"weeklyAvailableSlots"},{default:i(()=>[n(q,{modelValue:e.weeklyAvailableSlots,"onUpdate:modelValue":t[8]||(t[8]=f=>e.weeklyAvailableSlots=f),multiple:"",placeholder:"请选择可用时段",size:"large",disabled:s.value,style:{width:"100%"}},{default:i(()=>[n(k,{label:"工作日上午 (9:00-12:00)",value:"WEEKDAY_MORNING"}),n(k,{label:"工作日下午 (13:00-18:00)",value:"WEEKDAY_AFTERNOON"}),n(k,{label:"工作日晚上 (19:00-22:00)",value:"WEEKDAY_EVENING"}),n(k,{label:"周末上午 (9:00-12:00)",value:"WEEKEND_MORNING"}),n(k,{label:"周末下午 (13:00-18:00)",value:"WEEKEND_AFTERNOON"}),n(k,{label:"周末晚上 (19:00-22:00)",value:"WEEKEND_EVENING"})]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1},8,["model"]),n(G,null,{default:i(()=>[...t[19]||(t[19]=[V("问卷内容",-1)])]),_:1}),n(Se,{ref_key:"rendererRef",ref:M,schema:m.value,onSubmit:g},null,8,["schema"]),s.value?(u(),v("div",He,[n(_,{class:"is-loading",size:24},{default:i(()=>[n(L(X))]),_:1}),t[20]||(t[20]=b("span",null,"提交中…",-1))])):S("",!0)],64)):S("",!0)])])}}}),Be=H(Qe,[["__scopeId","data-v-f07c9ee3"]]);export{Be as default};
