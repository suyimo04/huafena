import{d as Q,u as W,y as X,c as y,a as c,t as m,n as E,v,w as d,C as Y,s as G,j as _,r as P,D as Z,o as s,f as U,b as g,i as B,k as ee,E as T,G as te,_ as ne}from"./index-Dmpy0hQc.js";import{i as A}from"./axios-DYop8cuN.js";function le(){return A.get("/salary/list")}function se(I){return A.post("/salary/batch-save",I)}function ae(){return A.post("/salary/calculate")}function ie(I){return A.post("/salary/archive",{operatorId:I})}const oe={class:"p-6"},ue={class:"flex items-center justify-between mb-4 flex-wrap gap-2"},de={class:"flex items-center gap-2"},re={key:0,class:"text-sm text-orange-500 font-medium"},ce={class:"flex items-center gap-2"},me={key:0,class:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm"},ve=["onClick"],fe={key:1},pe=["onClick"],ye={key:1},_e=["onClick"],ge={key:1},be=["onClick"],ke={key:1},he=["onClick"],Ce={key:1},xe=Q({__name:"SalaryPage",setup(I){const K=W(),C=G(()=>["ADMIN","LEADER"].includes(K.role)),f=_([]),M=_(!1),N=_(!1),L=_(!1),R=_(!1),x=_(""),p=ee(new Map),w=_(null),V=_(new Set),j=G(()=>p.size),q=G(()=>f.value);function u(l){if(!p.has(l)){const e=f.value.find(o=>o.id===l);e&&p.set(l,{...e})}return p.get(l)}function b(l,e){const o=p.get(l.id);return o?o[e]:l[e]}function $(l,e){var o,a;return C.value?((o=w.value)==null?void 0:o.id)===l&&((a=w.value)==null?void 0:a.field)===e:!1}function S(l,e){C.value&&(u(l.id),w.value={id:l.id,field:e})}function r(){w.value=null}function F({row:l}){return V.value.has(l.id)?"violating-row":""}async function D(){M.value=!0;try{const l=await le();f.value=l.data??[]}catch{f.value=[]}finally{M.value=!1}}async function H(){var k,z;x.value="",V.value.clear();const l=Array.from(p.values());if(l.length===0)return;const e=[],o=new Set;let a=0;for(const h of f.value){const i=p.get(h.id),t=i?i.miniCoins:h.miniCoins;a+=t,(t<200||t>400)&&(e.push(`成员 ${h.userId} 迷你币 ${t} 不在 [200, 400] 范围内`),o.add(h.id))}if(a>2e3&&e.push(`迷你币总额 ${a} 超过 2000 上限`),f.value.length!==5&&e.push(`正式成员数量为 ${f.value.length}，应为 5 人`),e.length>0){x.value=e.join("；"),V.value=o;return}N.value=!0;try{const i=(await se({records:l,operatorId:((k=K.user)==null?void 0:k.id)??0})).data;if(i!=null&&i.success)T.success("批量保存成功"),p.clear(),V.value.clear(),await D();else if(x.value=(i==null?void 0:i.globalError)??"保存失败",(z=i==null?void 0:i.violatingUserIds)!=null&&z.length){const t=new Set(i.violatingUserIds);f.value.forEach(n=>{t.has(n.userId)&&V.value.add(n.id)})}}catch{}finally{N.value=!1}}async function J(){L.value=!0;try{await ae(),T.success("薪资计算完成"),await D()}catch{}finally{L.value=!1}}async function O(){var l;try{await te.confirm("确定要归档当前薪资数据吗？","确认归档",{type:"warning"})}catch{return}R.value=!0;try{await ie(((l=K.user)==null?void 0:l.id)??0),T.success("归档成功"),await D()}catch{}finally{R.value=!1}}return X(D),(l,e)=>{const o=P("el-button"),a=P("el-table-column"),k=P("el-input-number"),z=P("el-input"),h=P("el-table"),i=Z("loading");return s(),y("div",oe,[e[13]||(e[13]=c("h2",{class:"text-xl font-semibold text-gray-800 mb-4"},"薪资管理",-1)),c("div",ue,[c("div",de,[j.value>0?(s(),y("span",re,m(j.value)+" 条未保存修改 ",1)):E("",!0)]),c("div",ce,[C.value?(s(),v(o,{key:0,type:"primary",loading:N.value,disabled:j.value===0,onClick:H},{default:d(()=>[...e[10]||(e[10]=[U(" 批量保存 ",-1)])]),_:1},8,["loading","disabled"])):E("",!0),C.value?(s(),v(o,{key:1,onClick:J,loading:L.value},{default:d(()=>[...e[11]||(e[11]=[U("计算薪资",-1)])]),_:1},8,["loading"])):E("",!0),C.value?(s(),v(o,{key:2,onClick:O,loading:R.value},{default:d(()=>[...e[12]||(e[12]=[U("归档",-1)])]),_:1},8,["loading"])):E("",!0)])]),x.value?(s(),y("div",me,m(x.value),1)):E("",!0),Y((s(),v(h,{data:q.value,stripe:"",class:"w-full","row-class-name":F},{default:d(()=>[g(a,{prop:"userId",label:"成员ID",width:"90"}),g(a,{label:"基础积分",width:"120"},{default:d(({row:t})=>[c("div",{onClick:n=>S(t,"basePoints"),class:"cursor-pointer min-h-[32px] flex items-center"},[$(t.id,"basePoints")?(s(),v(k,{key:0,modelValue:u(t.id).basePoints,"onUpdate:modelValue":n=>u(t.id).basePoints=n,min:0,size:"small",onBlur:e[0]||(e[0]=n=>r()),onKeyup:e[1]||(e[1]=B(n=>r(),["enter"]))},null,8,["modelValue","onUpdate:modelValue"])):(s(),y("span",fe,m(b(t,"basePoints")),1))],8,ve)]),_:1}),g(a,{label:"奖励积分",width:"120"},{default:d(({row:t})=>[c("div",{onClick:n=>S(t,"bonusPoints"),class:"cursor-pointer min-h-[32px] flex items-center"},[$(t.id,"bonusPoints")?(s(),v(k,{key:0,modelValue:u(t.id).bonusPoints,"onUpdate:modelValue":n=>u(t.id).bonusPoints=n,min:0,size:"small",onBlur:e[2]||(e[2]=n=>r()),onKeyup:e[3]||(e[3]=B(n=>r(),["enter"]))},null,8,["modelValue","onUpdate:modelValue"])):(s(),y("span",ye,m(b(t,"bonusPoints")),1))],8,pe)]),_:1}),g(a,{label:"扣减",width:"120"},{default:d(({row:t})=>[c("div",{onClick:n=>S(t,"deductions"),class:"cursor-pointer min-h-[32px] flex items-center"},[$(t.id,"deductions")?(s(),v(k,{key:0,modelValue:u(t.id).deductions,"onUpdate:modelValue":n=>u(t.id).deductions=n,min:0,size:"small",onBlur:e[4]||(e[4]=n=>r()),onKeyup:e[5]||(e[5]=B(n=>r(),["enter"]))},null,8,["modelValue","onUpdate:modelValue"])):(s(),y("span",ge,m(b(t,"deductions")),1))],8,_e)]),_:1}),g(a,{label:"总积分",width:"100"},{default:d(({row:t})=>[U(m(b(t,"totalPoints")),1)]),_:1}),g(a,{label:"迷你币",width:"100"},{default:d(({row:t})=>[c("div",{onClick:n=>S(t,"miniCoins"),class:"cursor-pointer min-h-[32px] flex items-center"},[$(t.id,"miniCoins")?(s(),v(k,{key:0,modelValue:u(t.id).miniCoins,"onUpdate:modelValue":n=>u(t.id).miniCoins=n,min:0,size:"small",onBlur:e[6]||(e[6]=n=>r()),onKeyup:e[7]||(e[7]=B(n=>r(),["enter"]))},null,8,["modelValue","onUpdate:modelValue"])):(s(),y("span",ke,m(b(t,"miniCoins")),1))],8,be)]),_:1}),g(a,{label:"薪资金额",width:"120"},{default:d(({row:t})=>[U(m(b(t,"salaryAmount")),1)]),_:1}),g(a,{label:"备注"},{default:d(({row:t})=>[c("div",{onClick:n=>S(t,"remark"),class:"cursor-pointer min-h-[32px] flex items-center"},[$(t.id,"remark")?(s(),v(z,{key:0,modelValue:u(t.id).remark,"onUpdate:modelValue":n=>u(t.id).remark=n,size:"small",onBlur:e[8]||(e[8]=n=>r()),onKeyup:e[9]||(e[9]=B(n=>r(),["enter"]))},null,8,["modelValue","onUpdate:modelValue"])):(s(),y("span",Ce,m(b(t,"remark")??"-"),1))],8,he)]),_:1})]),_:1},8,["data"])),[[i,M.value]])])}}}),Se=ne(xe,[["__scopeId","data-v-ba7c4093"]]);export{Se as default};
