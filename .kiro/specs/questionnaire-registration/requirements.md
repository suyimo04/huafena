# 需求文档：动态问卷报名系统

## 简介

动态问卷报名系统是一个完整的问卷驱动招募流程引擎。系统允许管理员通过可视化设计器创建和管理动态问卷模板，支持多种字段类型、条件逻辑、分组管理和版本控制。应聘者可通过注册报名或公开问卷链接两种入口提交报名信息，系统自动创建账号并进入审核流程。管理员可在招募管理面板中查看、筛选和管理所有报名信息。

## 术语表

- **问卷设计器（Questionnaire_Designer）**：可视化问卷模板编辑工具，支持拖拽排序、字段配置、条件逻辑和版本管理
- **问卷模板（Questionnaire_Template）**：由设计器创建的问卷结构定义，包含字段、分组和校验规则
- **问卷版本（Questionnaire_Version）**：问卷模板的特定版本快照，支持草稿和已发布状态
- **问卷回答（Questionnaire_Response）**：应聘者提交的问卷填写数据
- **报名申请（Application）**：应聘者的报名记录，关联问卷回答和审核状态
- **公开链接（Public_Link）**：无需登录即可访问的问卷链接，通过唯一 token 标识
- **条件逻辑（Conditional_Logic）**：根据用户已填写的答案动态控制字段显示/隐藏的规则
- **字段校验规则（Validation_Rules）**：对字段输入值的约束条件，如最小长度、正则匹配、数值范围等
- **招募管理面板（Recruitment_Panel）**：管理员查看和管理报名列表的界面
- **报名状态（Application_Status）**：报名流程中的状态，包括待初审、待AI面试、待复审、已通过、已拒绝

## 需求

### 需求 1：问卷设计器保存与版本管理

**用户故事：** 作为管理员（ADMIN/LEADER/VICE_LEADER），我希望能在可视化设计器中保存问卷模板并管理版本，以便迭代优化问卷内容。

#### 验收标准

1. WHEN 管理员点击保存按钮，THE 问卷设计器 SHALL 将当前字段定义、分组配置和条件逻辑序列化为 JSON 并保存为新的草稿版本
2. WHEN 管理员点击发布按钮，THE 问卷设计器 SHALL 将指定草稿版本标记为已发布状态，并更新模板的活跃版本引用
3. WHEN 管理员查看版本历史，THE 问卷设计器 SHALL 按版本号降序展示所有版本及其状态（草稿/已发布）
4. WHEN 管理员选择一个历史版本，THE 问卷设计器 SHALL 将该版本的字段定义加载到设计画布中
5. IF 保存操作失败，THEN THE 问卷设计器 SHALL 显示错误提示并保留当前编辑状态不丢失

### 需求 2：问卷字段类型与配置

**用户故事：** 作为管理员，我希望问卷支持多种字段类型和丰富的配置选项，以便设计出满足招募需求的问卷。

#### 验收标准

1. THE 问卷设计器 SHALL 支持以下字段类型：单选（SINGLE_CHOICE）、多选（MULTI_CHOICE）、填空（TEXT）、日期（DATE）、数字（NUMBER）、下拉选择（DROPDOWN）
2. WHEN 管理员配置字段时，THE 问卷设计器 SHALL 允许设置必填控制（required 属性）
3. WHEN 管理员配置字段校验规则时，THE 问卷设计器 SHALL 支持 minLength、maxLength、pattern、min、max、minDate、maxDate、minSelect、maxSelect 和 customMessage 规则
4. WHEN 管理员配置条件逻辑时，THE 问卷设计器 SHALL 支持 SHOW/HIDE 动作、AND/OR 逻辑运算符，以及 EQUALS、NOT_EQUALS、CONTAINS、GREATER_THAN、LESS_THAN、IN、NOT_IN 操作符
5. WHEN 管理员拖拽字段时，THE 问卷设计器 SHALL 更新字段的排序顺序并实时反映在设计画布中

### 需求 3：问卷字段分组管理

**用户故事：** 作为管理员，我希望能将问卷字段按逻辑分组，以便应聘者填写时有清晰的结构。

#### 验收标准

1. WHEN 管理员创建分组时，THE 问卷设计器 SHALL 创建一个包含名称和排序顺序的分组，并允许将字段分配到该分组
2. WHEN 管理员调整分组顺序时，THE 问卷设计器 SHALL 更新分组的排序顺序并在设计画布中实时反映
3. WHEN 问卷渲染时，THE 问卷引擎 SHALL 按分组排序顺序展示字段，未分组字段排列在最后

### 需求 4：问卷模板 JSON 序列化

**用户故事：** 作为系统，我需要将问卷模板结构可靠地序列化和反序列化，以便在前后端之间传输和持久化存储。

#### 验收标准

1. WHEN 保存问卷模板时，THE 问卷引擎 SHALL 将 QuestionnaireSchema（包含 groups 和 fields）序列化为 JSON 字符串
2. WHEN 加载问卷模板时，THE 问卷引擎 SHALL 将 JSON 字符串反序列化为 QuestionnaireSchema 对象
3. FOR ALL 合法的 QuestionnaireSchema 对象，序列化后再反序列化 SHALL 产生与原始对象等价的结果（往返一致性）

### 需求 5：问卷设计权限控制

**用户故事：** 作为系统管理员，我希望只有授权角色能设计和管理问卷模板，以确保问卷内容的质量和安全。

#### 验收标准

1. WHEN 角色为 ADMIN、LEADER 或 VICE_LEADER 的用户访问问卷模板管理接口时，THE 系统 SHALL 允许执行创建、更新、删除和发布操作
2. WHEN 非授权角色的用户访问问卷模板管理接口时，THE 系统 SHALL 返回 403 Forbidden 响应并拒绝操作
3. THE 系统 SHALL 在 SecurityConfig 中通过路径匹配配置问卷模板接口的角色访问控制

### 需求 6：注册报名入口

**用户故事：** 作为应聘者，我希望在注册账号时同时填写报名问卷，以便一次性完成注册和报名。

#### 验收标准

1. WHEN 应聘者在注册页面提交注册表单和问卷回答时，THE 系统 SHALL 创建用户账号（角色为 APPLICANT，状态为禁用）、保存问卷回答、并创建报名申请记录（状态为待初审）
2. WHEN 注册页面加载时，THE 系统 SHALL 获取当前活跃的问卷版本并动态渲染问卷字段
3. WHEN 应聘者填写问卷时，THE 系统 SHALL 根据条件逻辑实时计算字段可见性
4. WHEN 应聘者提交问卷回答时，THE 系统 SHALL 对所有可见且必填的字段执行校验，校验失败时阻止提交并显示具体错误信息
5. IF 注册过程中发生错误，THEN THE 系统 SHALL 显示错误信息并保留用户已填写的数据

### 需求 7：公开问卷链接报名入口

**用户故事：** 作为应聘者，我希望通过公开链接直接填写问卷报名，无需事先注册账号。

#### 验收标准

1. WHEN 应聘者通过公开链接访问问卷时，THE 系统 SHALL 根据链接 token 获取对应的问卷版本并渲染问卷
2. WHEN 应聘者通过公开链接提交问卷回答时，THE 系统 SHALL 自动生成用户账号（角色为 APPLICANT，状态为禁用）、保存问卷回答、并创建报名申请记录（状态为待初审）
3. WHEN 公开链接提交成功时，THE 系统 SHALL 返回自动生成的用户名和密码供应聘者记录
4. IF 公开链接已过期或无效，THEN THE 系统 SHALL 显示链接无效的提示信息并阻止问卷加载

### 需求 8：字段校验引擎

**用户故事：** 作为系统，我需要对问卷回答进行严格的字段校验，以确保收集到的数据质量。

#### 验收标准

1. WHEN 校验必填字段时，THE 字段校验引擎 SHALL 对空值（null、空字符串、空集合）返回必填错误
2. WHEN 校验文本字段时，THE 字段校验引擎 SHALL 根据 minLength、maxLength 和 pattern 规则验证输入值
3. WHEN 校验数字字段时，THE 字段校验引擎 SHALL 根据 min 和 max 规则验证数值范围
4. WHEN 校验日期字段时，THE 字段校验引擎 SHALL 根据 minDate 和 maxDate 规则验证日期范围
5. WHEN 校验多选字段时，THE 字段校验引擎 SHALL 根据 minSelect 和 maxSelect 规则验证选择数量
6. IF 校验规则 JSON 格式无效，THEN THE 字段校验引擎 SHALL 跳过规则校验并视为通过

### 需求 9：条件逻辑评估引擎

**用户故事：** 作为系统，我需要根据用户已填写的答案动态评估字段的可见性，以实现问卷的条件逻辑显示。

#### 验收标准

1. WHEN 条件逻辑配置为 SHOW 且条件满足时，THE 条件逻辑引擎 SHALL 返回字段可见
2. WHEN 条件逻辑配置为 SHOW 且条件不满足时，THE 条件逻辑引擎 SHALL 返回字段隐藏
3. WHEN 条件逻辑配置为 HIDE 且条件满足时，THE 条件逻辑引擎 SHALL 返回字段隐藏
4. WHEN 条件逻辑配置为 HIDE 且条件不满足时，THE 条件逻辑引擎 SHALL 返回字段可见
5. WHEN 逻辑运算符为 AND 时，THE 条件逻辑引擎 SHALL 要求所有条件均满足才视为条件满足
6. WHEN 逻辑运算符为 OR 时，THE 条件逻辑引擎 SHALL 只要任一条件满足即视为条件满足
7. IF 条件逻辑 JSON 为空或格式无效，THEN THE 条件逻辑引擎 SHALL 默认返回字段可见

### 需求 10：初审与账号激活

**用户故事：** 作为管理员，我希望对报名申请进行初审，通过后自动激活账号并推进到 AI 面试环节。

#### 验收标准

1. WHEN 管理员通过初审时，THE 系统 SHALL 将报名状态更新为初审通过、启用用户账号、并将报名状态推进到 AI 面试阶段
2. WHEN 管理员拒绝初审时，THE 系统 SHALL 将报名状态更新为已拒绝，用户账号保持禁用状态
3. WHEN 初审操作完成时，THE 系统 SHALL 在报名时间线中记录操作详情（操作人、时间、结果）

### 需求 11：报名列表与筛选

**用户故事：** 作为管理员，我希望在招募管理面板中查看和筛选报名列表，以便高效管理招募流程。

#### 验收标准

1. THE 招募管理面板 SHALL 按报名时间降序展示所有报名申请
2. WHEN 管理员按状态筛选时，THE 招募管理面板 SHALL 仅展示匹配状态（待初审/待AI面试/待复审/已通过/已拒绝）的报名记录
3. WHEN 管理员按年龄筛选时，THE 招募管理面板 SHALL 根据应聘者的计算年龄过滤报名记录
4. WHEN 管理员按学生身份筛选时，THE 招募管理面板 SHALL 根据教育阶段过滤报名记录
5. WHEN 管理员按中高考状态筛选时，THE 招募管理面板 SHALL 根据 examFlag 和 examType 过滤报名记录
6. WHEN 报名记录超过单页显示数量时，THE 招募管理面板 SHALL 提供分页功能，支持切换页码和调整每页显示数量
7. WHEN 管理员组合多个筛选条件时，THE 招募管理面板 SHALL 对所有条件取交集进行过滤
